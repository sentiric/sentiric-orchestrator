<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SENTIRIC | NEXUS v5.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #030303; --card: #0d0d0d; --accent: #00ffa3; --gpu: #bd00ff; --text: #f0f0f0; --dim: #555; --border: #1a1a1a; }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; margin: 0; padding: 25px; overflow-x: hidden; }
        header { display: flex; justify-content: space-between; border-bottom: 2px solid var(--border); padding-bottom: 20px; margin-bottom: 30px; }
        .brand { font-size: 24px; font-weight: 800; letter-spacing: -1px; } .brand span { color: var(--accent); }
        .section-title { font-size: 11px; font-weight: 800; color: #888; text-transform: uppercase; letter-spacing: 2px; margin: 30px 0 15px; display: flex; align-items: center; gap: 10px; }
        .section-title::after { content: ""; height: 1px; background: var(--border); flex: 1; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(360px, 1fr)); gap: 15px; }
        
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; transition: 0.2s; position: relative; }
        .card:hover { border-color: #333; }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .card-title { font-weight: 800; font-size: 15px; color: #fff; }
        
        .status-pill { font-size: 9px; padding: 3px 8px; border-radius: 20px; font-weight: 900; background: #222; color: #888; }
        .status-pill.online { background: rgba(0, 255, 163, 0.1); color: var(--accent); border: 1px solid rgba(0, 255, 163, 0.2); }
        
        .usage-row { margin-bottom: 12px; }
        .usage-label { display: flex; justify-content: space-between; font-size: 10px; font-weight: 700; color: #888; margin-bottom: 4px; }
        .bar-bg { height: 5px; background: #151515; border-radius: 3px; overflow: hidden; }
        .bar-fill { height: 100%; background: var(--accent); transition: width 0.8s ease-out; }
        .bar-fill.gpu { background: var(--gpu); }

        .gpu-badge { font-size: 9px; background: var(--gpu); color: #fff; padding: 2px 6px; border-radius: 4px; font-weight: 800; margin-left: 8px; vertical-align: middle; }
        
        .actions { display: flex; gap: 8px; margin-top: 15px; border-top: 1px solid var(--border); padding-top: 15px; }
        button { background: #151515; border: 1px solid #222; color: #888; padding: 7px 12px; font-family: inherit; font-size: 10px; font-weight: 700; border-radius: 6px; cursor: pointer; flex: 1; transition: 0.2s; }
        button:hover { color: #fff; border-color: #444; }
        button.primary { border-color: var(--accent); color: var(--accent); }
        button.primary:hover { background: var(--accent); color: #000; }

        #console { background: #000; border: 1px solid var(--border); border-radius: 8px; height: 200px; overflow-y: auto; padding: 15px; font-family: 'JetBrains Mono', monospace; font-size: 11px; color: #888; margin-top: 20px; }
    </style>
</head>
<body>
    <header>
        <div class="brand">SENTIRIC <span>NEXUS</span></div>
        <div id="clock" style="font-size: 14px; font-weight: 800; color: #444;">00:00:00</div>
    </header>

    <div class="section-title">Global Infrastructure Nodes</div>
    <div id="nodes-grid" class="grid"></div>

    <div class="section-title">Microservice Orchestration</div>
    <div id="services-grid" class="grid"></div>

    <div class="section-title">Cluster Operations Log</div>
    <div id="console">Waiting for event stream...</div>

    <script>
        const nodesGrid = document.getElementById('nodes-grid');
        const servicesGrid = document.getElementById('services-grid');
        const consoleEl = document.getElementById('console');

        setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleTimeString(); }, 1000);

        const ws = new WebSocket(`ws://${window.location.host}/ws`);
        ws.onmessage = (e) => {
            const msg = JSON.parse(e.data);
            if (msg.type === 'node_update') refreshNodes();
            if (msg.type === 'services_update') renderServices(msg.data);
            if (msg.type === 'log_stream') logEvent(msg.data);
        };

        async function refreshNodes() {
            const res = await fetch('/api/nodes');
            const nodes = await res.json();
            nodesGrid.innerHTML = nodes.map(n => `
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">${n.name}</div>
                        <div class="status-pill online">${n.status}</div>
                    </div>
                    ${createBar("CPU", n.cpu_usage)}
                    ${createBar("RAM", (n.ram_used/n.ram_total)*100, n.ram_used+"/"+n.ram_total+"MB")}
                    ${n.gpu_mem_total > 0 ? createBar("GPU", n.gpu_usage, n.gpu_usage+"%", "gpu") : ""}
                </div>
            `).join('');
        }

        function createBar(label, pct, detail = "", type = "") {
            return `<div class="usage-row">
                <div class="usage-label"><span>${label}</span><span>${detail || pct.toFixed(1)+'%'}</span></div>
                <div class="bar-bg"><div class="bar-fill ${type}" style="width:${pct}%"></div></div>
            </div>`;
        }

        function renderServices(services) {
            servicesGrid.innerHTML = services.sort((a,b) => a.name.localeCompare(b.name)).map(s => `
                <div class="card">
                    <div class="svc-header">
                        <span class="card-title">${s.name} ${s.has_gpu ? '<span class="gpu-badge">GPU</span>' : ''}</span>
                        <span class="status-pill online">RUNNING</span>
                    </div>
                    <div style="display:flex; gap:20px;">
                        <div style="flex:1">${createBar("CPU", s.cpu_usage)}</div>
                        <div style="flex:1">${createBar("RAM", (s.mem_usage/2048)*100, s.mem_usage+"MB")}</div>
                    </div>
                    <div class="actions">
                        <button onclick="toggleAP('${s.name}', ${!s.auto_pilot})">${s.auto_pilot ? 'ðŸŸ¢ AUTO-PILOT' : 'âšª MANUAL'}</button>
                        <button class="primary" onclick="updateSvc('${s.name}')">FORCE UPDATE</button>
                    </div>
                </div>
            `).join('');
        }

        function logEvent(d) {
            const div = document.createElement('div');
            div.innerHTML = `<span style="color:var(--accent)">[${d.node}]</span> <b>${d.service}</b>: ${d.msg}`;
            consoleEl.appendChild(div);
            consoleEl.scrollTop = consoleEl.scrollHeight;
            if(consoleEl.childElementCount > 50) consoleEl.removeChild(consoleEl.firstChild);
        }

        async function updateSvc(n) { if(confirm("Update "+n+"?")) await fetch('/api/update?service='+n, {method:'POST'}); }
        async function toggleAP(service, enabled) {
            await fetch('/api/toggle-autopilot', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({service, enabled}) });
        }

        refreshNodes();
        fetch('/api/status').then(r => r.json()).then(renderServices);
    </script>
</body>
</html>