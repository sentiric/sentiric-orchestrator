<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SENTIRIC | CLUSTER MANAGER</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #050505; --card: #0f0f0f; --accent: #00ff9d; --warn: #ffae00; --danger: #ff4444; --gpu: #bd00ff; --text: #e0e0e0; --border: #222; }
        body { background: var(--bg); color: var(--text); font-family: 'JetBrains Mono', monospace; margin: 0; padding: 20px; }
        header { display: flex; justify-content: space-between; border-bottom: 1px solid var(--border); padding-bottom: 15px; margin-bottom: 20px; }
        .brand { font-size: 20px; font-weight: 800; } .brand span { color: var(--accent); }
        .section-title { font-size: 12px; color: #666; font-weight: bold; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 15px; margin-bottom: 30px; }
        
        .node-card { background: #0a0a0a; border: 1px solid var(--border); border-left: 3px solid var(--accent); padding: 15px; border-radius: 4px; }
        .node-card.offline { border-left-color: var(--danger); opacity: 0.7; }
        .node-header { display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 10px; }
        .metric-bar { height: 4px; background: #222; margin-top: 5px; border-radius: 2px; overflow: hidden; }
        .metric-fill { height: 100%; background: var(--accent); transition: width 0.5s; }
        .metric-label { display: flex; justify-content: space-between; font-size: 10px; color: #888; margin-top: 8px; }
        
        .svc-card { background: var(--card); border: 1px solid var(--border); padding: 15px; border-radius: 4px; }
        .svc-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .svc-name { font-weight: bold; color: #fff; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--danger); }
        .status-dot.up { background: var(--accent); box-shadow: 0 0 5px var(--accent); }
        .svc-meta { font-size: 10px; color: #666; margin-bottom: 10px; display: flex; justify-content: space-between; }
        .actions { display: flex; gap: 10px; margin-top: 10px; }
        button { background: transparent; border: 1px solid #333; color: #aaa; padding: 5px 10px; font-family: inherit; font-size: 10px; cursor: pointer; border-radius: 3px; flex: 1; }
        button:hover { border-color: var(--accent); color: var(--accent); }
    </style>
</head>
<body>
    <header>
        <div class="brand">SENTIRIC <span>ORCHESTRATOR</span></div>
        <div style="font-size: 11px; color: #666">CLUSTER MANAGER v0.6</div>
    </header>

    <div class="section-title">INFRASTRUCTURE NODES (CPU / RAM / GPU)</div>
    <div id="nodes-grid" class="grid"></div>

    <div class="section-title">LOCAL MICROSERVICES</div>
    <div id="services-grid" class="grid"></div>

    <script>
        const nodesGrid = document.getElementById('nodes-grid');
        const servicesGrid = document.getElementById('services-grid');

        fetch('/api/nodes').then(r => r.json()).then(renderNodes);
        fetch('/api/status').then(r => r.json()).then(renderServices);

        const ws = new WebSocket(`ws://${window.location.host}/ws`);
        ws.onmessage = (e) => {
            const msg = JSON.parse(e.data);
            if (msg.type === 'node_update') updateNode(msg.data);
            if (msg.type === 'nodes_list_update') renderNodes(msg.data);
            if (msg.type === 'services_update') renderServices(msg.data);
        };

        function renderNodes(nodes) { nodesGrid.innerHTML = nodes.map(n => createNodeCard(n)).join(''); }
        function updateNode(node) { fetch('/api/nodes').then(r => r.json()).then(renderNodes); }

        function createNodeCard(n) {
            const isOnline = n.status === 'ONLINE';
            const cpuColor = n.cpu_usage > 80 ? 'var(--danger)' : 'var(--accent)';
            const ramPct = (n.ram_used / n.ram_total) * 100 || 0;
            const gpuPct = n.gpu_usage;
            const gpuMemPct = (n.gpu_mem_used / n.gpu_mem_total) * 100 || 0;
            
            let gpuSection = '';
            if (n.gpu_mem_total > 0) {
                gpuSection = `
                <div class="metric-label"><span>GPU LOAD</span> <span>${n.gpu_usage}%</span></div>
                <div class="metric-bar"><div class="metric-fill" style="width:${gpuPct}%; background:var(--gpu)"></div></div>
                <div class="metric-label"><span>GPU MEM</span> <span>${n.gpu_mem_used} / ${n.gpu_mem_total} MB</span></div>
                <div class="metric-bar"><div class="metric-fill" style="width:${gpuMemPct}%; background:var(--gpu)"></div></div>`;
            }

            return `
            <div class="node-card ${isOnline ? '' : 'offline'}">
                <div class="node-header">
                    <span>${n.name}</span>
                    <span style="color:${isOnline ? 'var(--accent)' : 'var(--danger)'}">${n.status}</span>
                </div>
                <div class="metric-label"><span>CPU</span> <span>${n.cpu_usage.toFixed(1)}%</span></div>
                <div class="metric-bar"><div class="metric-fill" style="width:${n.cpu_usage}%; background:${cpuColor}"></div></div>
                <div class="metric-label"><span>RAM</span> <span>${n.ram_used} / ${n.ram_total} MB</span></div>
                <div class="metric-bar"><div class="metric-fill" style="width:${ramPct}%"></div></div>
                ${gpuSection}
            </div>`;
        }

        function renderServices(services) {
            servicesGrid.innerHTML = services.map(s => {
                const isUp = s.status.toLowerCase().includes("up");
                return `
                <div class="svc-card">
                    <div class="svc-header">
                        <span class="svc-name">${s.name}</span>
                        <span class="status-dot ${isUp ? 'up' : ''}"></span>
                    </div>
                    <div class="svc-meta">
                        <span>${s.short_id}</span>
                        <span>${s.image.split(':')[1] || 'latest'}</span>
                    </div>
                    <div class="actions">
                         <button onclick="toggleAutoPilot('${s.name}', ${!s.auto_pilot})">${s.auto_pilot ? 'ðŸŸ¢ AUTO' : 'âšª MANUAL'}</button>
                         <button onclick="updateService('${s.name}')">UPDATE</button>
                    </div>
                </div>`;
            }).join('');
        }

        async function updateService(name) {
            if(!confirm("Update " + name + "?")) return;
            await fetch(`/api/update?service=${name}`, {method: 'POST'});
        }
        
        async function toggleAutoPilot(name, enabled) {
            await fetch('/api/toggle-autopilot', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({service: name, enabled}) });
            fetch('/api/status').then(r => r.json()).then(renderServices);
        }
    </script>
</body>
</html>